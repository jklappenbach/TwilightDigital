<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8"/>
    <title>{{ _('Create Account') }} • {{ _('Twilight Digital') }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='TwilightDigital.css') }}">
</head>
<body>
<header class="top-panel">
    <div class="top-inner">
        <div class="left-tools">
            <button class="hamburger" aria-label="{{ _('Menu') }}">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M3 6h18M3 12h18M3 18h18" stroke="white" stroke-opacity="0.9" stroke-width="2"
                          stroke-linecap="round"/>
                </svg>
            </button>
            <div class="search" role="search">
                <input type="search" placeholder="{{ _('search for creators') }}" aria-label="{{ _('Search creators') }}"/>
                <button class="icon-btn" aria-label="{{ _('Search') }}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <circle cx="11" cy="11" r="7" stroke="white" stroke-opacity="0.9" stroke-width="2"/>
                        <path d="M21 21l-3.5-3.5" stroke="white" stroke-opacity="0.9" stroke-width="2"
                              stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="brand">{{ _('Twilight Digital') }}</div>
        <div class="right-actions">
            <a class="btn" href="{{ url_for('landing_page') }}">{{ _('Cancel') }}</a>
        </div>
    </div>
</header>

<main class="container">
    <section class="main">
        <div class="card" style="grid-column: 1 / -1;">
            <h2>{{ _('Create your account') }}</h2>
            <p class="muted">{{ _('Join Twilight Digital to build, grow, and thrive.') }}</p>

            <!-- Wizard: Step 1 -->
            <div id="wizard-step-1" class="wizard-step">
                <div id="step1-email-block">
                    <label for="email" class="fw-700">{{ _('Email') }}</label>
                    <div style="margin-top:8px; max-width:520px;">
                        <input
                                id="email"
                                name="email"
                                type="email"
                                inputmode="email"
                                autocapitalize="none"
                                autocomplete="email"
                                spellcheck="false"
                                placeholder="{{ _('you@example.com') }}"
                                aria-label="{{ _('Email') }}"
                                style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg);"
                                value="{{ request.args.get('email', '') }}"
                                required
                        />
                    </div>
                </div>

                <div id="step1-code-block" hidden>
                    <label for="email-verification-code" class="fw-700">{{ _('Verification code') }}</label>
                    <div style="margin-top:8px; max-width:360px;">
                        <input
                                id="email-verification-code"
                                name="email_verification_code"
                                type="text"
                                inputmode="numeric"
                                pattern="[0-9]*"
                                placeholder="{{ _('123 456') }}"
                                aria-label="{{ _('Email Verification code') }}"
                                autocapitalize="none"
                                spellcheck="false"
                                style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg); letter-spacing: 0.2em; text-align:center;"
                                required
                        />
                    </div>
                </div>

                <div class="actions-row">
                    <button id="step1-action" class="btn btn-accent" type="button">{{ _('Send Verification Code') }}</button>
                </div>
            </div>

            <!-- Wizard: Step 2 -->
            <div id="wizard-step-2" class="wizard-step" hidden style="margin-top:18px;">
                <div class="fw-700" style="margin-bottom:8px;">{{ _('Set up 2FA') }}</div>
                <div class="tablist" role="tablist" aria-label="{{ _('2FA methods') }}">
                    <button role="tab" class="btn tab" id="tab-2fa-email" aria-controls="panel-2fa-email"
                            aria-selected="true">{{ _('Email') }}
                    </button>
                    <button role="tab" class="btn tab" id="tab-2fa-auth" aria-controls="panel-2fa-auth"
                            aria-selected="false">{{ _('Authenticator') }}
                    </button>
                    <button role="tab" class="btn tab" id="tab-2fa-sms" aria-controls="panel-2fa-sms"
                            aria-selected="false">{{ _('SMS') }}
                    </button>
                </div>
                <div class="tab-panels">
                    <section id="panel-2fa-email" role="tabpanel" aria-labelledby="tab-2fa-email">
                        <p class="muted">{{ _('Verify actions via codes sent to your configured email.') }}</p>
                        <div class="actions-row">
                            <button class="btn btn-accent" type="button">{{ _('Select') }}</button>
                        </div>
                    </section>
                    <section id="panel-2fa-auth" role="tabpanel" aria-labelledby="tab-2fa-auth" hidden>
                        <p class="muted">{{ _('Use a TOTP authenticator app to generate one-time codes.') }}</p>
                        <div id="otp-qr-panel" class="card" style="display:flex; gap:16px; align-items:center; max-width:520px; margin:12px 0; padding:12px;">
                            <div style="min-width:160px; min-height:160px; display:flex; align-items:center; justify-content:center; border:1px dashed var(--frost-border); border-radius: var(--radius); background: rgba(255,255,255,0.02);">
                                <img id="otp-qr-img" alt="{{ _('Authenticator QR Code') }}" style="display:none; width:160px; height:160px; image-rendering: pixelated;" />
                                <div id="otp-qr-loading" class="muted" style="font-size:14px;">{{ _('Preparing QR code…') }}</div>
                            </div>
                            <div>
                                <div class="muted" style="font-size:14px;">{{ _('1) Scan this QR in your authenticator app') }}<br/>{{ _('2) Then enter the 6-digit code below') }}</div>
                                <div id="otp-qr-error" class="muted" style="color:#ff9e9e; margin-top:8px; display:none;"></div>
                            </div>
                        </div>
                        <label for="otp-code" class="fw-700">{{ _('Enter Code') }}</label>
                        <div style="max-width:360px; margin-top:8px;">
                            <input
                                    id="otp-code"
                                    name="otp_code"
                                    type="text"
                                    inputmode="numeric"
                                    pattern="[0-9]*"
                                    placeholder="{{ _('123 456') }}"
                                    aria-label="{{ _('Authenticator code') }}"
                                    autocapitalize="none"
                                    spellcheck="false"
                                    style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg); letter-spacing: 0.2em; text-align:center;"
                            />
                        </div>
                        <div class="actions-row">
                            <button id="otp-verify-btn" class="btn" type="button">{{ _('Verify') }}</button>
                        </div>
                    </section>
                    <section id="panel-2fa-sms" role="tabpanel" aria-labelledby="tab-2fa-sms" hidden>
                        <p class="muted">{{ _('Receive codes via text message.') }}</p>
                        <div style="max-width:420px; margin-top:8px;">
                            <input
                                    type="tel"
                                    inputmode="tel"
                                    placeholder="{{ _('+1 555 123 4567') }}"
                                    aria-label="{{ _('Phone number') }}"
                                    autocapitalize="none"
                                    spellcheck="false"
                                    style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg);"
                            />
                        </div>
                        <div class="actions-row">
                            <button class="btn" type="button">{{ _('Link Phone') }}</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="footer">
    <div class="footer-inner">
        <div>
            <h4>{{ _('Twilight Digital') }}</h4>
            <p class="muted">{{ _('Empowering creators to build, grow, and thrive.') }}</p>
            <p class="muted mt-8">© 2025 {{ _('Twilight Digital') }}. {{ _('All rights reserved.') }}</p>
        </div>
        <div>
            <h4>{{ _('Site Map') }}</h4>
            <nav>
                <div><a href="{{ url_for('landing_page') }}">{{ _('Home') }}</a></div>
            </nav>
        </div>
        <div>
            <h4>{{ _('Support') }}</h4>
            <nav>
                <div><a href="#">{{ _('Help Center') }}</a></div>
            </nav>
        </div>
        <div>
            <h4>{{ _('Legal') }}</h4>
            <nav>
                <div><a href="#">{{ _('Privacy') }}</a></div>
                <div><a href="#">{{ _('Terms') }}</a></div>
            </nav>
        </div>
    </div>
</footer>

<script>
    // i18n strings injected from server
    // Wizard + tab behavior
    (function () {
        const I18N = {
            sending: "{{ _('Sending...') }}",
            sendVerificationCode: "{{ _('Send Verification Code') }}",
            submitCode: "{{ _('Submit Code') }}",
            failedToLoadQr: "{{ _('Failed to load QR code.') }}",
            failedToSendCode: "{{ _('Failed to send code') }}",
            internalErrorTryLater: "{{ _('Could not send code due to an internal error. Please try again later.') }}",
            submitCodeShort: "{{ _('Submit') }}",
            verificationFailed: "{{ _('Verification failed.') }}",
            networkErrorVerifying: "{{ _('Network error verifying code. Please try again.') }}",
            invalidOtpCode: "{{ _('Invalid OTP Code.  Please try again.') }}",
            failedToSendCodePrefix: "{{ _('Failed to send code:') }}",
            emailRequiredInline: "{{ _('Please enter a valid email address.') }}",
            preparingQr: "{{ _('Preparing QR code…') }}"
        };
        const sendCodeUrl = "{{ url_for('email_verification_code') }}";
        // Step 1 behavior
        const emailBlock = document.getElementById('step1-email-block');
        const codeBlock = document.getElementById('step1-code-block');
        const step1Action = document.getElementById('step1-action');
        const step1 = document.getElementById('wizard-step-1');
        const step2 = document.getElementById('wizard-step-2');
        let step1Mode = 'email'; // 'email' -> 'code'
        let tabsInitialized = false;

        // Maintain header-based session across AJAX calls
        const SESSION_HEADER = 'X-Session-Id';
        let sessionId = '{{sid}}';
        async function fetchWithSession(input, init = {}) {
            let res = null;
            init.headers = init.headers || {};
            if (sessionId) {
                init.headers[SESSION_HEADER] = sessionId;
                res = await fetch(input, init);
            } else {
                throw new Error("No session ID available!");
            }
            return res;
        }

        // OTP QR loader
        let otpQrObjectUrl = null;
        async function loadOtpQr() {
            const img = document.getElementById('otp-qr-img');
            const loading = document.getElementById('otp-qr-loading');
            const err = document.getElementById('otp-qr-error');

            if (!img || !loading || !err) return;

            // Reset UI
            err.style.display = 'none';
            err.textContent = '';
            loading.style.display = '';
            img.style.display = 'none';

            // Revoke any previously created object URL
            if (otpQrObjectUrl) {
                URL.revokeObjectURL(otpQrObjectUrl);
                otpQrObjectUrl = null;
            }

            try {
                const res = await fetchWithSession('/create-otp-qrcode', { method: 'GET' });
                if (!res.ok || !res.headers.get('Content-Type')?.includes('image/png')) {
                    // Attempt to parse error JSON for message
                    let message = I18N.failedToLoadQr;
                    try {
                        const j = await res.json();
                        if (j && j.error) message = j.error;
                    } catch (_) {}
                    throw new Error(message);
                }
                const blob = await res.blob();
                otpQrObjectUrl = URL.createObjectURL(blob);
                img.src = otpQrObjectUrl;
                img.onload = () => {
                    loading.style.display = 'none';
                    img.style.display = '';
                };
            } catch (e) {
                loading.style.display = 'none';
                err.textContent = (e && e.message) ? e.message : I18N.failedToLoadQr;
                err.style.display = '';
            }
        }

        // Trigger the button when pressing Enter on the email field (when valid)
        const emailInput = document.getElementById('email');
        if (emailInput && step1Action) {
            emailInput.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                const v = (emailInput.value || '').trim();
                if (emailInput.checkValidity() && v) {
                    step1Action.click();
                } else {
                    emailInput.reportValidity();
                }
            });
        }
        if (step1Action) {
            step1Action.addEventListener('click', async () => {
                if (step1Mode === 'email') {
                    // Send verification code
                    const email = (emailInput?.value || '').trim();
                    if (!emailInput?.checkValidity() || !email) {
                        emailInput?.focus();
                        emailInput?.setAttribute('aria-invalid', 'true');
                        return;
                    }
                    step1Action.disabled = true;
                    step1Action.textContent = I18N.sending;
                    try {
                        const res = await fetchWithSession(sendCodeUrl, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({email})
                        });
                        const data = await res.json().catch(() => ({}));
                        if (!res.ok || !data.ok) {
                            throw new Error(data.error || I18N.failedToSendCode);
                        }
                        // Swap to code entry
                        emailBlock.hidden = true;
                        codeBlock.hidden = false;
                        step1Action.textContent = I18N.submitCode;
                        step1Action.disabled = false;
                        step1Mode = 'code';
                        const code = document.getElementById('email-verification-code');
                        code?.focus();
                    } catch (e) {
                        step1Action.textContent = I18N.sendVerificationCode;
                        step1Action.disabled = false;
                        // Basic inline error hint
                        emailInput?.setCustomValidity(I18N.internalErrorTryLater);
                        emailInput?.reportValidity();
                        setTimeout(() => emailInput?.setCustomValidity(''), 2000);
                    }
                } else {
                    // Proceed to step 2
                    const codeInput = document.getElementById('email-verification-code');
                    try {
                        const res = await fetchWithSession('/verify-email-code', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({code: codeInput.value.trim(), email: emailInput.value.trim()}),
                        });
                        const payload = await res.json();

                        if (payload.ok) {
                            step1.hidden = true;
                            step2.hidden = false;
                            const otpVerifyButton = document.getElementById('otp-verify-btn');
                            otpVerifyButton.addEventListener('click', async () => {
                                try {
                                    const verifyCodeUrl = "{{ url_for('verify_otp_code') }}"
                                    const otpCodeField = document.getElementById("otp-code");
                                    const res = await fetchWithSession(verifyCodeUrl, {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({code: otpCodeField.value.trim()})
                                    });
                                    const data = await res.json().catch(() => ({}));
                                    if (!res.ok || !data.ok) {
                                        otpCodeField?.setCustomValidity(I18N.invalidOtpCode);
                                        otpCodeField?.reportValidity();
                                    } else {
                                        window.location.href = '{{ url_for("user_page") }}';
                                    }
                                } catch (e) {
                                    alert(I18N.failedToSendCodePrefix + ' ' + e.message);
                                }
                            });
                            initTabs(step2);
                        } else {
                            alert(payload.error || I18N.verificationFailed);
                        }
                    } catch (err) {
                        alert(I18N.networkErrorVerifying);
                    }

                }
            });


            // Tabs behavior (scoped initializer)
            function initTabs(scope) {
                const tablists = Array.from(scope.querySelectorAll('.tablist'));
                tablists.forEach(tablist => {
                    const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                    const panels = Array.from(scope.querySelectorAll('[role="tabpanel"]'));

                    function activate(tab) {
                        tabs.forEach(t => t.setAttribute('aria-selected', String(t === tab)));
                        panels.forEach(p => {
                            const isActive = p.id === tab.getAttribute('aria-controls');
                            if (isActive)
                                p.removeAttribute('hidden')
                            else
                                p.setAttribute('hidden', '');
                        });

                        // When switching to the Authenticator tab, load the QR via AJAX
                        if (tab.id === 'tab-2fa-auth') {
                            loadOtpQr();
                        }
                    }

                    tablist.addEventListener('click', (e) => {
                        const btn = e.target.closest('[role="tab"]');
                        if (!btn) return;
                        activate(btn);
                    });
                    tablist.addEventListener('keydown', (e) => {
                        const idx = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
                        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                            e.preventDefault();
                            const dir = e.key === 'ArrowRight' ? 1 : -1;
                            const next = tabs[(idx + dir + tabs.length) % tabs.length];
                            next.focus();
                            activate(next);
                        }
                    });
                });
            }
        }
    })();
</script>
</body>
</html>
