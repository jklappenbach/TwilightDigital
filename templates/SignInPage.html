<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8"/>
    <title>{{ _('Sign In') }} • {{ _('Twilight Digital') }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='TwilightDigital.css') }}">
</head>
<body>
<header class="top-panel">
    <div class="top-inner">
        <div class="left-tools">
            <button class="hamburger" aria-label="{{ _('Menu') }}">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M3 6h18M3 12h18M3 18h18" stroke="white" stroke-opacity="0.9" stroke-width="2"
                          stroke-linecap="round"/>
                </svg>
            </button>
            <div class="search" role="search">
                <input type="search" placeholder="{{ _('search for creators') }}" aria-label="{{ _('Search creators') }}"/>
                <button class="icon-btn" aria-label="{{ _('Search') }}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <circle cx="11" cy="11" r="7" stroke="white" stroke-opacity="0.9" stroke-width="2"/>
                        <path d="M21 21l-3.5-3.5" stroke="white" stroke-opacity="0.9" stroke-width="2"
                              stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="brand">{{ _('Twilight Digital') }}</div>
        <div class="right-actions">
            <a class="btn" href="{{ url_for('landing_page') }}">{{ _('Cancel') }}</a>
        </div>
    </div>
</header>

<main class="container">
    <section class="main">
        <div class="card" style="grid-column: 1 / -1;">
            <h2>{{ _('Sign in to your account') }}</h2>
            <p class="muted">{{ _('Welcome back to Twilight Digital.') }}</p>

            <!-- Email input section (top half) -->
            <div id="email-section" style="margin-bottom: 32px;">
                <label for="email" class="fw-700">{{ _('Email Address') }}</label>
                <div style="margin-top:8px; max-width:520px;">
                    <input
                        id="email"
                        name="email"
                        type="email"
                        inputmode="email"
                        autocapitalize="none"
                        autocomplete="email"
                        spellcheck="false"
                        placeholder="{{ _('you@example.com') }}"
                        aria-label="{{ _('Email') }}"
                        style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg);"
                        value="{{ request.args.get('email', '') }}"
                        required
                    />
                </div>
            </div>

            <!-- Tabbed authentication section (lower half) -->
            <div id="auth-section">
                <div class="fw-700" style="margin-bottom:12px;">{{ _('Choose authentication method') }}</div>
                <div class="tablist" role="tablist" aria-label="{{ _('Authentication methods') }}">
                    <button role="tab" class="btn tab" id="tab-email" aria-controls="panel-email"
                            aria-selected="true">{{ _('Email') }}
                    </button>
                    <button role="tab" class="btn tab" id="tab-otp" aria-controls="panel-otp"
                            aria-selected="false">{{ _('OTP') }}
                    </button>
                </div>

                <div class="tab-panels">
                    <!-- Email Tab -->
                    <section id="panel-email" role="tabpanel" aria-labelledby="tab-email">
                        <p class="muted">{{ _("We'll send a verification code to your email address.") }}</p>

                        <!-- Initial panel: Send verification code -->
                        <div id="email-send-panel">
                            <div class="actions-row">
                                <button id="send-code-btn" class="btn btn-accent" type="button">{{ _('Send Verification Code') }}</button>
                            </div>
                        </div>

                        <!-- Code input panel: Enter and verify code -->
                        <div id="email-verify-panel" style="display:none; margin-top:24px;">
                            <label for="email-verification-code" class="fw-700">{{ _('Enter Verification Code') }}</label>
                            <div style="margin-top:8px; max-width:360px;">
                                <input
                                    id="email-verification-code"
                                    name="email_verification_code"
                                    type="text"
                                    inputmode="numeric"
                                    pattern="[0-9]*"
                                    placeholder="{{ _('123456') }}"
                                    aria-label="{{ _('Email verification code') }}"
                                    autocapitalize="none"
                                    spellcheck="false"
                                    maxlength="6"
                                    style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg); letter-spacing: 0.2em; text-align:center;"
                                    required
                                />
                                <div id="code-error-message" class="error-message" style="display:none; color: var(--danger-color, #ef4444); font-size: 0.875rem; margin-top: 8px;"></div>
                            </div>
                            <div class="actions-row">
                                <button id="submit-code-btn" class="btn btn-accent" type="button">{{ _('Submit') }}</button>
                                <button id="resend-code-btn" class="btn btn-outline" type="button">{{ _('Resend Code') }}</button>
                            </div>
                        </div>
                    </section>

                    <!-- OTP Tab -->
                    <section id="panel-otp" role="tabpanel" aria-labelledby="tab-otp" hidden>
                        <p class="muted">{{ _('Enter the code from your authenticator app.') }}</p>

                        <label for="otp-code" class="fw-700">{{ _('Authenticator Code') }}</label>
                        <div style="max-width:360px; margin-top:8px;">
                            <input
                                id="otp-code"
                                name="otp_code"
                                type="text"
                                inputmode="numeric"
                                pattern="[0-9]*"
                                placeholder="{{ _('123 456') }}"
                                aria-label="{{ _('Authenticator code') }}"
                                autocapitalize="none"
                                spellcheck="false"
                                style="width:100%; padding:12px 14px; border-radius: var(--radius); border:1px solid var(--frost-border); background: var(--search-bg); color: var(--fg); letter-spacing: 0.2em; text-align:center;"
                                required
                            />
                        </div>
                        <div class="actions-row">
                            <button id="verify-otp-btn" class="btn btn-accent" type="button">{{ _('Sign In') }}</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="footer">
    <div class="footer-inner">
        <div>
            <h4>{{ _('Twilight Digital') }}</h4>
            <p class="muted">{{ _('Empowering creators to build, grow, and thrive.') }}</p>
            <p class="muted mt-8">© 2025 {{ _('Twilight Digital') }}. {{ _('All rights reserved.') }}</p>
        </div>
        <div>
            <h4>{{ _('Site Map') }}</h4>
            <nav>
                <div><a href="{{ url_for('landing_page') }}">{{ _('Home') }}</a></div>
            </nav>
        </div>
        <div>
            <h4>{{ _('Support') }}</h4>
            <nav>
                <div><a href="#">{{ _('Help Center') }}</a></div>
            </nav>
        </div>
        <div>
            <h4>{{ _('Legal') }}</h4>
            <nav>
                <div><a href="#">{{ _('Privacy') }}</a></div>
                <div><a href="#">{{ _('Terms') }}</a></div>
            </nav>
        </div>
    </div>
</footer>

<script>

    (function () {
        const I18N = {
            sending: "{{ _('Sending...') }}",
            sendVerificationCode: "{{ _('Send Verification Code') }}",
            failedToSendVerificationCode: "{{ _('Failed to send verification code:') }}",
            pleaseEnter6Digit: "{{ _('Please enter the 6-digit verification code.') }}",
            verifying: "{{ _('Verifying...') }}",
            submit: "{{ _('Submit') }}",
            resendCode: "{{ _('Resend Code') }}",
            invalidCode: "{{ _('The verification code is incorrect.') }}",
            anErrorOccurred: "{{ _('An error occurred. Please try again.') }}",
            signIn: "{{ _('Sign In') }}",
            invalidAuthenticatorCode: "{{ _('Invalid authenticator code') }}"
        };

        // Maintain header-based session across AJAX calls
        const SESSION_HEADER = 'X-Session-Id';
        let sessionId = '{{sid}}';
        async function fetchWithSession(input, init = {}) {
            let res = null;
            init.headers = init.headers || {};
            if (sessionId) {
                init.headers[SESSION_HEADER] = sessionId;
                res = await fetch(input, init);
            } else {
                throw new Error("No session ID available!");
            }
            return res;
        }

        // Initialize tabs
        function initTabs() {
            const tablist = document.querySelector('.tablist');
            const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
            const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

            function activate(tab) {
                tabs.forEach(t => t.setAttribute('aria-selected', String(t === tab)));
                panels.forEach(p => {
                    const isActive = p.id === tab.getAttribute('aria-controls');
                    if (isActive) {
                        p.removeAttribute('hidden');
                    } else {
                        p.setAttribute('hidden', '');
                    }
                });
            }

            tablist.addEventListener('click', (e) => {
                const btn = e.target.closest('[role="tab"]');
                if (!btn) return;
                activate(btn);
            });

            tablist.addEventListener('keydown', (e) => {
                const idx = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    const dir = e.key === 'ArrowRight' ? 1 : -1;
                    const next = tabs[(idx + dir + tabs.length) % tabs.length];
                    next.focus();
                    activate(next);
                }
            });
        }

        // Email verification flow
        const emailInput = document.getElementById('email');
        const emailSendPanel = document.getElementById('email-send-panel');
        const emailVerifyPanel = document.getElementById('email-verify-panel');
        const sendCodeBtn = document.getElementById('send-code-btn');
        const emailCodeInput = document.getElementById('email-verification-code');
        const submitCodeBtn = document.getElementById('submit-code-btn');
        const resendCodeBtn = document.getElementById('resend-code-btn');
        const codeErrorMessage = document.getElementById('code-error-message');

        const otpCodeInput = document.getElementById('otp-code');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');

        function clearCodeError() {
            codeErrorMessage.style.display = 'none';
            codeErrorMessage.textContent = '';
            emailCodeInput.setCustomValidity('');
        }

        function showCodeError(message) {
            codeErrorMessage.textContent = message;
            codeErrorMessage.style.display = 'block';
            emailCodeInput.setCustomValidity(message);
            emailCodeInput.reportValidity();
        }

        async function sendVerificationCode() {
            const email = emailInput.value.trim();
            if (!emailInput.checkValidity() || !email) {
                emailInput.focus();
                emailInput.reportValidity();
                return;
            }

            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = I18N.sending;

            try {
                const response = await fetchWithSession("{{ url_for('email_verification_code') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const result = await response.json();

                if (response.ok && result.ok) {
                    // Hide initial panel, show code entry panel
                    emailSendPanel.style.display = 'none';
                    emailVerifyPanel.style.display = 'block';
                    emailCodeInput.value = '';
                    clearCodeError();
                    emailCodeInput.focus();
                } else {
                    throw new Error(result.error || I18N.failedToSendVerificationCode);

                }
            } catch (err) {
                alert(`${I18N.failedToSendVerificationCode} ${err.message}`);
            } finally {
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = I18N.sendVerificationCode;
            }
        }

        async function submitVerificationCode() {
            const email = emailInput.value.trim();
            const code = emailCodeInput.value.trim();

            if (!code || code.length !== 6) {
                showCodeError(I18N.pleaseEnter6Digit);
                return;
            }

            submitCodeBtn.disabled = true;
            submitCodeBtn.textContent = I18N.verifying;
            clearCodeError();

            try {
                const response = await fetchWithSession("{{ url_for('verify_email_code') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const result = await response.json();

                if (response.ok && result.ok) {
                    window.location.href = "{{ url_for('twilight_digital_user_page') }}";
                } else {
                    showCodeError(result.error || I18N.invalidCode);
                    emailCodeInput.focus();
                }
            } catch (err) {
                showCodeError(I18N.anErrorOccurred);
            } finally {
                submitCodeBtn.disabled = false;
                submitCodeBtn.textContent = I18N.submit;
            }
        }

        async function resendVerificationCode() {
            resendCodeBtn.disabled = true;
            resendCodeBtn.textContent = I18N.sending;
            clearCodeError();
            try {
                await sendVerificationCode();
            } finally {
                resendCodeBtn.disabled = false;
                resendCodeBtn.textContent = I18N.resendCode;
            }
        }

        // Wire up email verification events
        sendCodeBtn.addEventListener('click', sendVerificationCode);
        submitCodeBtn.addEventListener('click', submitVerificationCode);
        resendCodeBtn.addEventListener('click', resendVerificationCode);

        // OTP verification using fetchWithSession -> verify_otp_code
        verifyOtpBtn.addEventListener('click', async () => {
            const otpCode = otpCodeInput.value.trim();
            if (!otpCode) {
                otpCodeInput.focus();
                otpCodeInput.setCustomValidity("{{ _('Please enter your authenticator code') }}");
                otpCodeInput.reportValidity();
                return;
            }

            verifyOtpBtn.disabled = true;
            verifyOtpBtn.textContent = I18N.signIn;


            try {
                const response = await fetchWithSession("{{ url_for('verify_otp_code') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: otpCode })
                });
                const result = await response.json();

                if (response.ok && result.ok) {
                    window.location.href = "{{ url_for('twilight_digital_user_page') }}";
                } else {
                    throw new Error(I18N.invalidAuthenticatorCode);

                }
            } catch {
                verifyOtpBtn.textContent = I18N.signIn;
                verifyOtpBtn.disabled = false;
                otpCodeInput.setCustomValidity('Invalid code. Please try again.');
                otpCodeInput.reportValidity();
                setTimeout(() => otpCodeInput.setCustomValidity(''), 3000);
            }
        });

        // Enter key handling
        emailInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendCodeBtn.disabled && emailSendPanel.style.display !== 'none') {
                e.preventDefault();
                sendCodeBtn.click();
            }
        });
        emailCodeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !submitCodeBtn.disabled) {
                e.preventDefault();
                submitCodeBtn.click();
            }
        });
        emailCodeInput.addEventListener('input', clearCodeError);
        otpCodeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !verifyOtpBtn.disabled) {
                e.preventDefault();
                verifyOtpBtn.click();
            }
        });

        // Initialize tabs on page load
        initTabs();
    })();
</script>
</body>
</html>
